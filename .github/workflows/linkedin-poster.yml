name: LinkedIn Auto-Poster

on:
  schedule:
    # Runs every 2 hours from 6am to 10pm AEST (UTC+11)
    # 6am AEST = 7pm UTC (previous day)
    # 10pm AEST = 11am UTC
    - cron: '0 19,21,23,1,3,5,7,9,11 * * *'
  workflow_dispatch:  # Manual trigger

jobs:
  post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Run LinkedIn Poster
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
        run: |
          python linkedin_poster.py
      
      - name: Commit and push log
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add posted_linkedin.json
          git commit -m "Update LinkedIn posted log [skip ci]" || exit 0
          for i in 1 2 3; do
            git pull --rebase origin main && git push && break
            echo "Retry $i..."
            sleep 5
          done
