# .github/workflows/linkedin-poster.yml
# This workflow posts to LinkedIn on a schedule

name: LinkedIn Auto-Poster

on:
  # Run every 2 hours during active hours (script adds 0-60 min random delay = 2-3 hr effective)
  # Times in UTC - AEST = UTC+10
  schedule:
    # Every 2 hours from 6am-10pm AEST
    - cron: '0 20,22 * * *'      # 6am, 8am AEST
    - cron: '0 0,2,4,6,8,10,12 * * *'  # 10am-10pm AEST (every 2 hrs)
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  post:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests
      
      - name: Run LinkedIn Poster
        env:
          LINKEDIN_ACCESS_TOKEN: ${{ secrets.LINKEDIN_ACCESS_TOKEN }}
          LINKEDIN_USER_ID: ${{ secrets.LINKEDIN_USER_ID }}
        run: |
          python linkedin_poster.py
      
      - name: Commit and push log
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add posted.json
          git commit -m "Update posted log [skip ci]" || exit 0
          for i in 1 2 3; do
            git pull --rebase origin main && git push && break
            echo "Retry $i..."
            sleep 5
          done
